name: End-to-end test

env:
  SCRIPTS_DIR: ./.github/scripts

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Validate manifests"]
    types:
      - completed

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [local] # Add more environments here when needed
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Flux
        uses: fluxcd/flux2/action@main
      - name: Extract branch name
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
        id: extract_branch
      - name: Setup Kubernetes
        uses: AbsaOSS/k3d-action@v2.4.0
        with:
          cluster-name: cluster-ci
          k3d-version: v5.5.2
          args: >-
            --config=$SCRIPTS_DIR/cluster-config/cluster-ci.yaml
      - name: Install Flux
        run: flux install
      - name: Setup cluster reconciliation
        run: $SCRIPTS_DIR/e2e-setup-cluster-reconciliation.sh ${{ github.event.repository.html_url }} ${{ steps.extract_branch.outputs.branch }} ${{ matrix.environment }} ${{ github.actor }} ${{ secrets.GITHUB_TOKEN }}
      - name: Verify cluster reconciliation
        run: $SCRIPTS_DIR/e2e-verify-cluster-reconciliation.sh
      - name: Verify helm reconciliation
        run: $SCRIPTS_DIR/e2e-verify-helm-reconciliation.sh
      # Run e2e tests for apps here
      # ...
      - name: Debug failure
        if: failure()
        run: $SCRIPTS_DIR/e2e-debug-failure.sh
