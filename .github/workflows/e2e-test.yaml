name: End-to-end test

on:
  workflow_dispatch:
  push:
    branches: 'main'
  pull_request:
    branches: 'main'

jobs:
  end-to-end-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Flux
        uses: fluxcd/flux2/action@main
      - name: Extract branch name
        shell: bash
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
        id: extract_branch
      - name: Setup Kubernetes
        uses: nolar/setup-k3d-k3s@v1
        with:
          k3d-name: cluster-test
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install Flux
        run: flux install
      - name: Setup cluster reconciliation
        run: ./.github/scripts/e2e-setup-cluster-reconciliation.sh
        shell: bash
      - name: Verify cluster reconciliation
        run: ./.github/scripts/e2e-verify-cluster-reconciliation.sh
        shell: bash
      - name: Verify helm reconciliation
        run: ./.github/scripts/e2e-verify-helm-reconciliation.sh
        shell: bash
      - name: Debug failure
        if: failure()
        run: ./.github/scripts/e2e-debug-failure.sh
        shell: bash
