networks:
  public:
    external: true
  internal:
    external: true

services:
  jaeger-collector:
    image: jaegertracing/jaeger-collector:1.43.0
    environment:
      SPAN_STORAGE_TYPE: elasticsearch
      ES_SERVER_URLS: http://elasticsearch:9200
    ports:
      - 14250:14250 # The port of the collector's gRPC server
      - 14268:14268 # The port of the collector's HTTP server
      - 14269:14269 # The port for the collector's admin server, including health check, /metrics, etc.
    networks:
      - internal
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:14269 || exit 1

  jaeger-query:
    image: jaegertracing/jaeger-query:1.43.0
    labels:
      traefik.enable: true
      traefik.http.routers.jaeger.entrypoints: ${TRAEFIK_ENTRYPOINTS?}
      traefik.http.routers.jaeger.rule: Host(`jaeger.${DOMAIN}`)
      traefik.http.services.jaeger.loadbalancer.server.port: 16686
    environment:
      SPAN_STORAGE_TYPE: elasticsearch
      ES_SERVER_URLS: http://elasticsearch:9200
      METRICS_STORAGE_TYPE: prometheus
      PROMETHEUS_SERVER_URL: http://prometheus:9090
    ports:
      - 16685:16685 # The port of the query's gRPC server
      - 16687:16687 # The port for the query's admin server, including health check, /metrics, etc.
    networks:
      - public
      - internal
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:16687 || exit 1
