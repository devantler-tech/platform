# Setup keycloak, and remove Cloudflare auth.
## Should use Traefik ForwardAuth instead.
## Look into how to handle policies in keycloak.
## Look into potential policy enforcemnent service, or consider if it makes sense to enforce policies decentralized.

networks:
  public:
    external: true
  internal:
    external: true
  

services:
  server:
    image: quay.io/keycloak/keycloak:21.1.1
    restart: unless-stopped
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD?}
      KC_HOSTNAME: auth.${DOMAIN?}
      KC_HOSTNAME_ADMIN_URL: keycloak.${DOMAIN?}
      KC_PROXY: edge
      KC_DB: ${KC_DB?}
      KC_DB_URL_HOST: ${KC_DB_URL_HOST?}
      KC_DB_USERNAME: ${KC_DB_USERNAME?}
      KC_DB_PASSWORD: ${KC_DB_PASSWORD?}
      KC_HEALTH_ENABLED: true
    command: start
    labels:
      traefik.enable: true
      traefik.http.routers.keycloak.service: keycloak
      traefik.http.routers.keycloak.rule: Host(`keycloak.${DOMAIN?}`)
      traefik.http.routers.keycloak.entrypoints: ${TRAEFIK_ENTRYPOINTS:-https}
      traefik.http.services.keycloak.loadbalancer.server.port: 8080

      traefik.http.routers.keycloak-auth.service: keycloak-auth
      traefik.http.routers.keycloak-auth.rule: Host(`auth.${DOMAIN?}`)
      traefik.http.routers.keycloak-auth.entrypoints: ${TRAEFIK_ENTRYPOINTS:-https}
      traefik.http.services.keycloak-auth.loadbalancer.server.port: 8080
    networks:
      - public
      - internal