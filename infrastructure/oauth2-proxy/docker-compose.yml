networks:
  internal:
    external: true
  public:
    external: true

services:
  server:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.4.0
    environment:
        OAUTH2_PROXY_PROVIDER: keycloak-oidc
        OAUTH2_PROXY_CLIENT_ID: ${OAUTH2_PROXY_CLIENT_ID?}
        OAUTH2_PROXY_CLIENT_SECRET: ${OAUTH2_PROXY_CLIENT_SECRET?}
        OAUTH2_PROXY_REDIRECT_URL: https://oauth2-proxy.${DOMAIN?}/oauth2/callback
        OAUTH2_PROXY_OIDC_ISSUER_URL: https://auth.${DOMAIN?}/realms/master
        OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_PROXY_COOKIE_SECRET?}
        OAUTH2_PROXY_EMAIL_DOMAINS: '*'
        OAUTH2_PROXY_HTTP_ADDRESS: '0.0.0.0:4180'
        OAUTH2_PROXY_REVERSE_PROXY: true
    labels:
      traefik.enable: true
      traefik.http.routers.oauth2-proxy.rule: Host(`oauth2-proxy.${DOMAIN?}`)
      traefik.http.routers.oauth2-proxy.entrypoints: ${TRAEFIK_ENTRYPOINTS:-https}
      traefik.http.services.oauth2-proxy.loadbalancer.server.port: 4180
    networks:
      - public
      - internal