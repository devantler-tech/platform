networks:
  internal:
    external: true
  public:
    external: true

services:
  server:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.4.0
    restart: unless-stopped
    environment:
        OAUTH2_PROXY_PROVIDER: keycloak-oidc
        OAUTH2_PROXY_CLIENT_ID: ${OAUTH2_PROXY_CLIENT_ID?}
        OAUTH2_PROXY_CLIENT_SECRET: ${OAUTH2_PROXY_CLIENT_SECRET?}
        OAUTH2_PROXY_REDIRECT_URL: https://oauth2-proxy.${DOMAIN?}/oauth2/callback
        OAUTH2_PROXY_OIDC_ISSUER_URL: https://auth.${DOMAIN?}/realms/master
        OAUTH2_PROXY_COOKIE_SECURE: false
        OAUTH2_PROXY_EMAIL_DOMAINS: '*'
        OAUTH2_PROXY_HTTP_ADDRESS: '0.0.0.0:4180'
        OAUTH2_PROXY_REVERSE_PROXY: true
        OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: true
    labels:
      traefik.enable: true
      traefik.http.routers.oauth2-proxy.rule: Host(`oauth2-proxy.${DOMAIN?}`) || PathPrefix(`/oauth2`)
      traefik.http.routers.oauth2-proxy.entrypoints: ${TRAEFIK_ENTRYPOINTS:-https}
      traefik.http.services.oauth2-proxy.loadbalancer.server.port: 4180

      traefik.http.middlewares.auth-verify.forwardAuth.address: https://oauth2-proxy.${DOMAIN?}/oauth2/auth
      traefik.http.middlewares.auth-verify.forwardAuth.trustForwardHeader: true
      traefik.http.middlewares.auth-verify.forwardAuth.authResponseHeaders: X-Auth-Request-User,X-Auth-Request-Email,Set-Cookie
      traefik.http.middlewares.auth-signin.errors.service: oauth2-proxy@docker
      traefik.http.middlewares.auth-signin.errors.status: '401'
      traefik.http.middlewares.auth-signin.errors.query: /oauth2/sign_in
    networks:
      - public
      - internal