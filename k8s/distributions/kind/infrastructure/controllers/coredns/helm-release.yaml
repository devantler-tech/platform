apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: coredns
  namespace: kube-system
  labels:
    helm.toolkit.fluxcd.io/helm-test: enabled
    helm.toolkit.fluxcd.io/remediation: enabled
spec:
  interval: 10m
  chart:
    spec:
      chart: coredns
      version: 1.42.2
      sourceRef:
        kind: HelmRepository
        name: coredns
  # https://github.com/coredns/helm/blob/master/charts/coredns/values.yaml
  values:
    servers:
      - zones:
          - zone: .${domain}
            port: 53
            plugins:
              - name: errors
              - name: cache
                parameters: 30
              - name: forward
                parameters: . 172.17.0.1
          - zone: .
            port: 53
            plugins:
              - name: errors
              # Serves a /health endpoint on :8080, required for livenessProbe
              - name: health
                configBlock: |-
                  lameduck 10s
              # Serves a /ready endpoint on :8181, required for readinessProbe
              - name: ready
              # Required to query kubernetes API for data
              - name: kubernetes
                parameters: cluster.local in-addr.arpa ip6.arpa
                configBlock: |-
                  pods insecure
                  fallthrough in-addr.arpa ip6.arpa
                  ttl 30
              # Serves a /metrics endpoint on :9153, required for serviceMonitor
              - name: prometheus
                parameters: 0.0.0.0:9153
              - name: forward
                parameters: . /etc/resolv.conf
              - name: cache
                parameters: 30
              - name: loop
              - name: reload
              - name: loadbalance
