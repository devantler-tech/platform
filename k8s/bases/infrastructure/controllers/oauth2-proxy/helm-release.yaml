---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: oauth2-proxy
  namespace: oauth2-proxy
  labels:
    # helm.toolkit.fluxcd.io/crds: enabled
    # helm.toolkit.fluxcd.io/helm-test: enabled
    helm.toolkit.fluxcd.io/remediation: enabled
spec:
  interval: 10m
  chart:
    spec:
      chart: oauth2-proxy
      version: 7.12.16
      sourceRef:
        kind: HelmRepository
        name: oauth2-proxy
  # https://github.com/oauth2-proxy/manifests/blob/main/helm/oauth2-proxy/values.yaml
  values:
    replicaCount: ${oauth2_proxy_replicas:=2}
    config:
      clientID: "${github_app_client_id}"
      clientSecret: "${github_app_client_secret}"
      cookieSecret: "${oauth2_proxy_cookie_secret}"
      # TODO: Remove scope and test if it works without it
      configFile: |-
        provider = "github"
        github_org = "devantler-tech"
        skip_provider_button = true
        reverse_proxy = true
        scope = "user:email"
        email_domains = [ "*" ]
        cookie_domains=[".${domain}"]
        upstreams = [ "static://202" ]
    ingress:
      enabled: true
      hosts:
        - oauth2-proxy.${domain}
