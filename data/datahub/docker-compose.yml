networks:
  internal:
    external: true
  public:
    external: true
services:
  datahub-actions:
    depends_on:
      - datahub-gms
    environment:
      DATAHUB_GMS_HOST: datahub-gms
      DATAHUB_GMS_PORT: 8080
      DATAHUB_GMS_PROTOCOL: http
      DATAHUB_SYSTEM_CLIENT_ID: __datahub_system
      DATAHUB_SYSTEM_CLIENT_SECRET: ${DATAHUB_SYSTEM_CLIENT_SECRET?}
      KAFKA_BOOTSTRAP_SERVER: kafka:9092
      KAFKA_PROPERTIES_SECURITY_PROTOCOL: PLAINTEXT
      METADATA_AUDIT_EVENT_NAME: MetadataAuditEvent_v4
      METADATA_CHANGE_LOG_VERSIONED_TOPIC_NAME: MetadataChangeLog_Versioned_v1
      SCHEMA_REGISTRY_URL: http://schema-registry:8081
    image: acryldata/datahub-actions:v0.0.11
    networks:
      - internal
    restart: unless-stopped
  datahub-frontend-react:
    depends_on:
      - datahub-gms
    environment:
      DATAHUB_APP_VERSION: 1
      DATAHUB_GMS_HOST: datahub-gms
      DATAHUB_GMS_PORT: 8080
      DATAHUB_PLAY_MEM_BUFFER_SIZE: 10MB
      DATAHUB_SECRET: ${DATAHUB_SECRET?}
      DATAHUB_TRACKING_TOPIC: DataHubUsageEvent_v1
      ELASTIC_CLIENT_HOST: elasticsearch
      ELASTIC_CLIENT_PORT: 9200
      JAVA_OPTS: '-Xms512m -Xmx512m -Dhttp.port=9002 -Dconfig.file=datahub-frontend/conf/application.conf -Djava.security.auth.login.config=datahub-frontend/conf/jaas.conf -Dlogback.configurationFile=datahub-frontend/conf/logback.xml -Dlogback.debug=false -Dpidfile.path=/dev/null'
      KAFKA_BOOTSTRAP_SERVER: kafka:9092
    image: linkedin/datahub-frontend-react:v0.10.0
    labels:
      traefik.enable: true
      traefik.http.routers.datahub.entrypoints: ${TRAEFIK_ENTRYPOINTS?}
      traefik.http.routers.datahub.rule: Host(`datahub.${DOMAIN?}`)
    networks:
      - internal
      - public
    restart: unless-stopped
    volumes:
      - datahub-plugins:/etc/datahub/plugins
  datahub-gms:
    environment:
      DATAHUB_SERVER_TYPE: quickstart
      DATAHUB_TELEMETRY_ENABLED: true
      DATAHUB_UPGRADE_HISTORY_KAFKA_CONSUMER_GROUP_ID: generic-duhe-consumer-job-client-gms
      EBEAN_DATASOURCE_DRIVER: org.postgresql.Driver
      EBEAN_DATASOURCE_HOST: postgres:5432
      EBEAN_DATASOURCE_PASSWORD: ${DATASOURCE_PASSWORD?}
      EBEAN_DATASOURCE_URL: jdbc:postgresql://postgres:5432/datahub?verifyServerCertificate=false&useSSL=true&useUnicode=yes&characterEncoding=UTF-8
      EBEAN_DATASOURCE_USERNAME: postgres
      ELASTICSEARCH_HOST: elasticsearch
      ELASTICSEARCH_INDEX_BUILDER_MAPPINGS_REINDEX: true
      ELASTICSEARCH_INDEX_BUILDER_SETTINGS_REINDEX: true
      ELASTICSEARCH_PORT: 9200
      ENTITY_REGISTRY_CONFIG_PATH: /datahub/datahub-gms/resources/entity-registry.yml
      ENTITY_SERVICE_ENABLE_RETENTION: true
      ES_BULK_REFRESH_POLICY: WAIT_UNTIL
      GRAPH_SERVICE_DIFF_MODE_ENABLED: true
      GRAPH_SERVICE_IMPL: elasticsearch
      JAVA_OPTS: '-Xms1g -Xmx1g'
      KAFKA_BOOTSTRAP_SERVER: kafka:9092
      KAFKA_SCHEMAREGISTRY_URL: http://schema-registry:8081
      MAE_CONSUMER_ENABLED: true
      MCE_CONSUMER_ENABLED: true
      PE_CONSUMER_ENABLED: true
      UI_INGESTION_ENABLED: true
    image: linkedin/datahub-gms:v0.10.0
    networks:
      - internal
    volumes:
      - datahub-plugins:/etc/datahub/plugins
  datahub-upgrade:
    command:
      - '-u'
      - SystemUpdate
    container_name: datahub-upgrade
    environment:
      DATAHUB_GMS_HOST: datahub-gms
      DATAHUB_GMS_PORT: 8080
      EBEAN_DATASOURCE_DRIVER: org.postgresql.Driver
      EBEAN_DATASOURCE_HOST: postgres:5432
      EBEAN_DATASOURCE_PASSWORD: ${DATASOURCE_PASSWORD?}
      EBEAN_DATASOURCE_URL: jdbc:postgresql://postgres:5432/datahub?verifyServerCertificate=false&useSSL=true&useUnicode=yes&characterEncoding=UTF-8
      EBEAN_DATASOURCE_USERNAME: postgres
      ELASTICSEARCH_BUILD_INDICES_CLONE_INDICES: false
      ELASTICSEARCH_HOST: elasticsearch
      ELASTICSEARCH_INDEX_BUILDER_MAPPINGS_REINDEX: true
      ELASTICSEARCH_INDEX_BUILDER_SETTINGS_REINDEX: true
      ELASTICSEARCH_PORT: 9200
      ENTITY_REGISTRY_CONFIG_PATH: /datahub/datahub-gms/resources/entity-registry.yml
      GRAPH_SERVICE_IMPL: elasticsearch
      KAFKA_BOOTSTRAP_SERVER: kafka:9092
      KAFKA_SCHEMAREGISTRY_URL: http://schema-registry:8081
    image: acryldata/datahub-upgrade:v0.10.0
    networks:
      - internal
  elasticsearch-setup:
    environment:
      ELASTICSEARCH_HOST: elasticsearch
      ELASTICSEARCH_PORT: 9200
      ELASTICSEARCH_PROTOCOL: http
    image: linkedin/datahub-elasticsearch-setup:v0.10.0
    networks:
      - internal
  kafka-setup:
    environment:
      DATAHUB_PRECREATE_TOPICS: false
      KAFKA_BOOTSTRAP_SERVER: kafka:9092
    image: linkedin/datahub-kafka-setup:v0.10.0
    networks:
      - internal
  postgres-setup:
    environment:
      DATAHUB_DB_NAME: datahub
      POSTGRES_HOST: postgres
      POSTGRES_PASSWORD: ${DATASOURCE_PASSWORD?}
      POSTGRES_PORT: 5432
      POSTGRES_USERNAME: postgres
    image: acryldata/datahub-postgres-setup:v0.10.0
    networks:
      - internal
volumes:
  datahub-plugins: null
