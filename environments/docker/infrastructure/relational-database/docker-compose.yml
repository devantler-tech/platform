services:
  postgres:
    image: postgres:15.3
    restart: unless-stopped
    healthcheck:
      test: pg_isready -U postgres
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD?}
    networks:
      - internal
    volumes:
      - postgres-data:/var/lib/postgresql/data

  pgweb:
    image: sosedoff/pgweb:0.14.1
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: nc -vz 127.0.0.1 8081 || exit 1
    environment:
      PGWEB_DATABASE_URL: postgres://postgres:${POSTGRES_PASSWORD?}@relational-database-postgres-1:5432?sslmode=disable
    labels:
      traefik.enable: true
      traefik.http.routers.pgweb.entrypoints: ${TRAEFIK_ENTRYPOINTS:-https}
      traefik.http.routers.pgweb.rule: Host(`postgres.${DOMAIN?}`)
      traefik.http.routers.pgweb.middlewares: auth
    networks:
      - internal
      - public

networks:
  internal:
    external: true
  public:
    external: true


volumes:
  postgres-data:
