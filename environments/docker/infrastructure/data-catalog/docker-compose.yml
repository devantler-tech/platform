services:
  datahub-actions:
    image: acryldata/datahub-actions:v0.0.12
    restart: unless-stopped
    depends_on:
      - datahub-gms
    environment:
      DATAHUB_GMS_HOST: data-catalog-datahub-gms-1
      DATAHUB_GMS_PORT: 8080
      DATAHUB_GMS_PROTOCOL: http
      DATAHUB_SYSTEM_CLIENT_ID: __datahub_system
      DATAHUB_SYSTEM_CLIENT_SECRET: ${DATAHUB_SYSTEM_CLIENT_SECRET?}
      KAFKA_BOOTSTRAP_SERVER: event-streaming-kafka-1:9092
      KAFKA_PROPERTIES_SECURITY_PROTOCOL: PLAINTEXT
      METADATA_AUDIT_EVENT_NAME: MetadataAuditEvent_v4
      METADATA_CHANGE_LOG_VERSIONED_TOPIC_NAME: MetadataChangeLog_Versioned_v1
      SCHEMA_REGISTRY_URL: http://schema-registry-kafka-1:8081
    networks:
      - internal

  datahub-frontend-react:
    image: linkedin/datahub-frontend-react:v0.10.2
    restart: unless-stopped
    depends_on:
      - datahub-gms
    environment:
      DATAHUB_APP_VERSION: 1
      DATAHUB_GMS_HOST: data-catalog-datahub-gms-1
      DATAHUB_GMS_PORT: 8080
      DATAHUB_PLAY_MEM_BUFFER_SIZE: 10MB
      DATAHUB_SECRET: ${DATAHUB_SECRET?}
      DATAHUB_TRACKING_TOPIC: DataHubUsageEvent_v1
      ELASTIC_CLIENT_HOST: search-engine-elasticsearch-1
      ELASTIC_CLIENT_PORT: 9200
      JAVA_OPTS: '-Xms512m -Xmx512m -Dhttp.port=9002 -Dconfig.file=datahub-frontend/conf/application.conf -Djava.security.auth.login.config=datahub-frontend/conf/jaas.conf -Dlogback.configurationFile=datahub-frontend/conf/logback.xml -Dlogback.debug=false -Dpidfile.path=/dev/null'
      KAFKA_BOOTSTRAP_SERVER: event-streaming-kafka-1:9092
      METADATA_SERVICE_AUTH_ENABLED: true
      AUTH_OIDC_ENABLED: true
      AUTH_OIDC_CLIENT_ID: ${OIDC_CLIENT_ID?}
      AUTH_OIDC_CLIENT_SECRET: ${OIDC_CLIENT_SECRET?}
      AUTH_OIDC_DISCOVERY_URI: https://auth.${DOMAIN?}/realms/master/.well-known/openid-configuration
      AUTH_OIDC_BASE_URL: https://datahub.${DOMAIN?}
    labels:
      traefik.enable: true
      traefik.http.routers.datahub.entrypoints: ${TRAEFIK_ENTRYPOINTS:-https}
      traefik.http.routers.datahub.rule: Host(`datahub.${DOMAIN?}`) || Host(`data-catalog.${DOMAIN?}`)
    networks:
      - internal
      - public
    volumes:
      - datahub-plugins:/etc/datahub/plugins

  datahub-gms:
    image: linkedin/datahub-gms:v0.10.2
    restart: unless-stopped
    environment:
      DATAHUB_SERVER_TYPE: quickstart
      DATAHUB_TELEMETRY_ENABLED: true
      DATAHUB_UPGRADE_HISTORY_KAFKA_CONSUMER_GROUP_ID: generic-duhe-consumer-job-client-gms
      EBEAN_DATASOURCE_DRIVER: org.postgresql.Driver
      EBEAN_DATASOURCE_HOST: relational-database-postgres-1:5432
      EBEAN_DATASOURCE_PASSWORD: ${DATASOURCE_PASSWORD?}
      EBEAN_DATASOURCE_URL: jdbc:postgresql://relational-database-postgres-1:5432/datahub?verifyServerCertificate=false&useSSL=true&useUnicode=yes&characterEncoding=UTF-8
      EBEAN_DATASOURCE_USERNAME: postgres
      ELASTICSEARCH_HOST: search-engine-elasticsearch-1
      ELASTICSEARCH_INDEX_BUILDER_MAPPINGS_REINDEX: true
      ELASTICSEARCH_INDEX_BUILDER_SETTINGS_REINDEX: true
      ELASTICSEARCH_PORT: 9200
      ENTITY_REGISTRY_CONFIG_PATH: /datahub/datahub-gms/resources/entity-registry.yml
      ENTITY_SERVICE_ENABLE_RETENTION: true
      ES_BULK_REFRESH_POLICY: WAIT_UNTIL
      GRAPH_SERVICE_DIFF_MODE_ENABLED: true
      GRAPH_SERVICE_IMPL: elasticsearch
      JAVA_OPTS: '-Xms1g -Xmx1g'
      KAFKA_BOOTSTRAP_SERVER: event-streaming-kafka-1:9092
      KAFKA_SCHEMAREGISTRY_URL: http://schema-registry-kafka-1:8081
      MAE_CONSUMER_ENABLED: true
      MCE_CONSUMER_ENABLED: true
      METADATA_SERVICE_AUTH_ENABLED: true
      REST_API_AUTHORIZATION_ENABLED: true
      PE_CONSUMER_ENABLED: true
      UI_INGESTION_ENABLED: true
    networks:
      - internal
    volumes:
      - datahub-plugins:/etc/datahub/plugins

  datahub-upgrade:
    image: acryldata/datahub-upgrade:v0.10.2
    command: -u SystemUpdate
    environment:
      DATAHUB_GMS_HOST: data-catalog-datahub-gms-1
      DATAHUB_GMS_PORT: 8080
      EBEAN_DATASOURCE_DRIVER: org.postgresql.Driver
      EBEAN_DATASOURCE_HOST: relational-database-postgres-1:5432
      EBEAN_DATASOURCE_PASSWORD: ${DATASOURCE_PASSWORD?}
      EBEAN_DATASOURCE_URL: jdbc:postgresql://relational-database-postgres-1:5432/datahub?verifyServerCertificate=false&useSSL=true&useUnicode=yes&characterEncoding=UTF-8
      EBEAN_DATASOURCE_USERNAME: postgres
      ELASTICSEARCH_BUILD_INDICES_CLONE_INDICES: false
      ELASTICSEARCH_HOST: search-engine-elasticsearch-1
      ELASTICSEARCH_INDEX_BUILDER_MAPPINGS_REINDEX: true
      ELASTICSEARCH_INDEX_BUILDER_SETTINGS_REINDEX: true
      ELASTICSEARCH_PORT: 9200
      ENTITY_REGISTRY_CONFIG_PATH: /datahub/datahub-gms/resources/entity-registry.yml
      GRAPH_SERVICE_IMPL: elasticsearch
      KAFKA_BOOTSTRAP_SERVER: event-streaming-kafka-1:9092
      KAFKA_SCHEMAREGISTRY_URL: http://schema-registry-kafka-1:8081
    networks:
      - internal

  datahub-elasticsearch-setup:
    image: linkedin/datahub-elasticsearch-setup:v0.10.2
    environment:
      ELASTICSEARCH_HOST: search-engine-elasticsearch-1
      ELASTICSEARCH_PORT: 9200
      ELASTICSEARCH_PROTOCOL: http
    networks:
      - internal

  datahub-kafka-setup:
    image: linkedin/datahub-kafka-setup:v0.10.2
    environment:
      DATAHUB_PRECREATE_TOPICS: false
      KAFKA_BOOTSTRAP_SERVER: event-streaming-kafka-1:9092
    networks:
      - internal

  datahub-postgres-setup:
    image: acryldata/datahub-postgres-setup:v0.10.3
    environment:
      DATAHUB_DB_NAME: datahub
      POSTGRES_HOST: relational-database-postgres-1
      POSTGRES_PASSWORD: ${DATASOURCE_PASSWORD?}
      POSTGRES_PORT: 5432
      POSTGRES_USERNAME: postgres
    networks:
      - internal

networks:
  internal:
    external: true
  public:
    external: true

volumes:
  datahub-plugins:
