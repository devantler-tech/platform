networks:
  public:
    external: true
  internal:
    external: true

services:
  jaeger-collector:
    image: jaegertracing/jaeger-collector:1.45.0
    environment:
      SPAN_STORAGE_TYPE: elasticsearch
      ES_SERVER_URLS: http://elasticsearch-server-1:9200
      # Necessary as elasticsearch doesn't work with version 8 yet https://github.com/jaegertracing/jaeger/issues/3571
      #ES_VERSION: 7
      #ES_CREATE_INDEX_TEMPLATES: false
    networks:
      - internal
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:14269 || exit 1

  jaeger-query:
    image: jaegertracing/jaeger-query:1.45.0
    labels:
      traefik.enable: true
      traefik.http.routers.jaeger.entrypoints: ${TRAEFIK_ENTRYPOINTS:-https}
      traefik.http.routers.jaeger.rule: Host(`jaeger.${DOMAIN}`)
      traefik.http.services.jaeger.loadbalancer.server.port: 16686
    environment:
      SPAN_STORAGE_TYPE: elasticsearch
      ES_SERVER_URLS: http://elasticsearch-server-1:9200
      METRICS_STORAGE_TYPE: prometheus
      PROMETHEUS_SERVER_URL: http://prometheus-server-1:9090
      # Necessary as elasticsearch doesn't work with version 8 yet https://github.com/jaegertracing/jaeger/issues/3571
      #ES_VERSION: 7
      #ES_CREATE_INDEX_TEMPLATES: false
    networks:
      - public
      - internal
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:16687 || exit 1

  prometheus:
    image: prom/prometheus:v2.44.0
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    networks:
      - public
      - internal
    labels:
      traefik.enable: 'true'
      traefik.http.routers.prometheus.rule: Host(`prometheus.${DOMAIN?}`)
      traefik.http.routers.prometheus.entrypoints: ${TRAEFIK_ENTRYPOINTS:-https}
      traefik.http.routers.prometheus.middlewares: auth
    restart: unless-stopped
    volumes:
      - prometheus:/prometheus
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    healthcheck:
      test: wget -qO- http://localhost:9090

  opentelemetry-collector:
    image: otel/opentelemetry-collector-contrib:0.75.0
    command: --config=/etc/otel-collector-config.yaml
    restart: unless-stopped
    ports:
      - 4317:4317
    networks:
      - internal
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml

volumes:
  prometheus: